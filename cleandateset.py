import os
import numpy as np
import csv
import pandas as pd
import json

path = "/home/kali/Desktop/ExploitExpert/data"
target_file = os.path.join(path, 'target_dataset.csv')
os_file = os.path.join(path, 'ostype.csv')
ser_file = os.path.join(path, 'services.csv')
exp_file = os.path.join(path, 'exploit_list.csv')

print('Get target dataset')
data = pd.read_csv(target_file)
dataset = data.drop(['exploit_sucess','opened_port_list'], axis=1)
y = data['exploit_sucess']

ostype = data['os_type']
os = pd.read_csv(os_file)
os = os['os_type'].tolist()
for rowidx, row in enumerate(ostype):
    for osidx, osnum in enumerate(os):
        if osnum == row:
            data.loc[rowidx, 'os_type'] = osidx+1

service_list = data['opened_service_list']
ser = pd.read_csv(ser_file)
sername = ser['service'].tolist()
for rowidx, row in enumerate(service_list):
    row = row.replace("'", '')
    row = row.replace(' ', '')
    tolist = row[1:-1].split(',')
    newlist=[]
    for seridx, sernum in enumerate(tolist):
        for idx, num in enumerate(sername):
            # print(sernum, num)
            if num in sernum:
                newlist.append(idx+1)
                data.loc[rowidx, 'opened_service_list'] = [frozenset(newlist)]
                break

    # while len(newlist) < len(sername):
    #     newlist.append(0)

sl = data['service_list']
exp_data = pd.read_csv(exp_file)
exploit_list = exp_data.values.tolist()
for rowidx, row in enumerate(sl):
    row = row.replace("'", '"')
    row = row.replace(' ', '')
    tojson = json.loads(row)
    newlist=[]
    for expidx, exp in enumerate(tojson):
        for e in exp['exploit']:
            for idx, num in enumerate(exploit_list):
                if e == num[0]:
                    newlist.append(idx+1)
                    data.loc[rowidx, 'service_list'] = [frozenset(newlist)]
                    break

print(data['service_list'])
